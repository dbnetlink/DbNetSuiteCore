"use strict";class DbNetEdit extends DbNetGridEdit{constructor(n){super(n);this.changes={};this.currentRow=1;this.layoutColumns=1;this.primaryKey="";this.search=!0;this.totalRows=0;this.isEditDialog=!1;this.toolbarPosition==undefined&&(this.toolbarPosition="Bottom")}initialize(){this.element&&(this.element.empty(),this.toolbarPosition=="Top"&&(this.toolbarPanel=this.addPanel("toolbar")),this.formPanel=this.addPanel("form"),this.toolbarPosition=="Bottom"&&(this.toolbarPanel=this.addPanel("toolbar")),this.addLoadingPanel(),this.post("initialize",this.getRequest()).then(n=>{n.error==!1&&(this.updateColumns(n),this.configureEdit(n))}),this.initialised=!0,this.fireEvent("onInitialized"))}addLinkedControl(n){this.linkedControls.push(n)}getRows(n){this.callServer("search",n)}configureEdit(n){var t,i;this.toolbarPanel&&(n.toolbar&&((t=this.toolbarPanel)===null||t===void 0?void 0:t.html(n.toolbar)),this.configureToolbar(n));n.form&&((i=this.formPanel)===null||i===void 0?void 0:i.html(n.form),this.configureForm());this.updateForm(n)}configureForm(){var n,t,i,r,u;const f=(n=this.formPanel)===null||n===void 0?void 0:n.find(`:input[name]`);for(let n=0;n<f.length;n++){const t=$(f[n]);this.fireEvent("onFormElementCreated",{formElement:t[0],columnName:t.attr("name")})}(t=this.formPanel)===null||t===void 0?void 0:t.find("[button-type='calendar']").on("click",n=>this.selectDate(n));(i=this.formPanel)===null||i===void 0?void 0:i.find("[button-type='clock']").on("click",n=>this.selectTime(n));(r=this.formPanel)===null||r===void 0?void 0:r.find("[button-type='lookup']").on("click",n=>this.editLookup(n));(u=this.formPanel)===null||u===void 0?void 0:u.find("input[datatype='DateTime'").get().forEach(n=>{const t=$(n);this.addDatePicker(t,this.datePickerOptions)})}updateForm(n){var t,i,r;if(n.totalRows==0){(t=this.formPanel)===null||t===void 0?void 0:t.find(":input").val("").not("[primarykey='true']").prop("checked",!1).prop("selected",!1).prop("disabled",!0);return}(i=this.formPanel)===null||i===void 0?void 0:i.find(":input").not("[primarykey='true']").prop("disabled",!1);const u=n.record;for(const n in u){const t=(r=this.formPanel)===null||r===void 0?void 0:r.find(`:input[name='${n}']`),i=u[n];if(t.attr("type")=="checkbox"){const n=i===!0;t.prop("checked",n).data("value",n)}else t.val(i.toString()).data("value",i.toString())}this.primaryKey=n.primaryKey;n.message&&this.message(n.message)}callServer(n,t){this.post(n,this.getRequest()).then(n=>{n.error==!1&&(this.configureToolbar(n),this.updateForm(n)),t&&t(n)})}getRequest(){return{changes:this.changes,componentId:this.id,connectionString:this.connectionString,columns:this.columns.map(n=>n),currentRow:this.currentRow,culture:this.culture,fromPart:this.fromPart,layoutColumns:this.layoutColumns,navigation:this.navigation,quickSearch:this.quickSearch,quickSearchToken:this.quickSearchToken,search:this.search,searchFilterJoin:this.searchFilterJoin,searchParams:this.searchParams,totalRows:this.totalRows,primaryKey:this.primaryKey,isEditDialog:this.isEditDialog}}configureToolbar(n){if(n.toolbar)["First","Next","Previous","Last","Cancel","Apply","Search"].forEach(n=>this.addEventListener(`${n}Btn`));const t=this.controlElement("dbnetedit-toolbar").find(".navigation"),i=this.controlElement("no-records-cell");this.setInputElement("Rows",n.totalRows);n.totalRows==0?(t.hide(),i.show()):(t.show(),i.hide(),this.controlElement("dbnetgrid-toolbar").find(".navigation").show(),this.setInputElement("RowNumber",n.currentRow),this.setInputElement("RowCount",n.totalRows),this.currentRow=n.currentRow,this.totalRows=n.totalRows,this.disable("FirstBtn",n.currentRow==1),this.disable("PreviousBtn",n.currentRow==1),this.disable("NextBtn",n.currentRow==n.totalRows),this.disable("LastBtn",n.currentRow==n.totalRows));this.controlElement("QuickSearch").on("keyup",n=>this.quickSearchKeyPress(n))}updateColumns(n){var t;this.columns=[];(t=n.columns)===null||t===void 0?void 0:t.forEach(n=>{const t={columnExpression:n.columnExpression,columnName:n.columnName,label:n.label,format:n.format,foreignKey:n.foreignKey,foreignKeyValue:n.foreignKeyValue,lookup:n.lookup,style:n.style,display:n.display,dataType:n.dataType,primaryKey:n.primaryKey,index:n.index,editControlType:n.editControlType,pattern:n.pattern};this.columns.push(new EditColumn(t))})}addEventListener(n,t="click"){this.controlElement(n).on(t,n=>this.handleClick(n))}handleClick(n){const t=n.target.id;switch(t){case this.controlElementId("FirstBtn"):this.currentRow=1;break;case this.controlElementId("NextBtn"):this.currentRow++;break;case this.controlElementId("PreviousBtn"):this.currentRow--;break;case this.controlElementId("LastBtn"):this.currentRow=this.totalRows;break;case this.controlElementId("SearchBtn"):case this.controlElementId("CancelBtn"):case this.controlElementId("ApplyBtn"):break;default:return}n.preventDefault();switch(t){case this.controlElementId("SearchBtn"):this.openSearchDialog(this.getRequest());break;case this.controlElementId("ApplyBtn"):this.applyChanges();break;default:this.getRecord()}}getRecord(n=null){n&&(this.primaryKey=n);this.callServer("getrecord")}applyChanges(){var t;const n={};let i=!0;((t=this.formPanel)===null||t===void 0?void 0:t.find(":input.dbnetedit,select.dbnetedit").each(function(){const t=$(this),r=t.attr("name");if(t.attr("type")=="checkbox")t.prop("checked")!=t.data("value")&&(n[r]=t.prop("checked"));else{if(t.attr("pattern")){const n=t[0].reportValidity();n||(i=!1)}t.val()!=t.data("value")&&(n[r]=t.val())}}),$.isEmptyObject(n))||i&&(this.changes=n,this.callServer("applychanges"))}message(n){var t;(t=this.formPanel)===null||t===void 0?void 0:t.find(".message").html(n).addClass("highlight");setInterval(()=>this.clearMessage(),5e3)}clearMessage(){var n;(n=this.formPanel)===null||n===void 0?void 0:n.find(".message").html("&nbsp;").removeClass("highlight")}selectDate(n){const t=$(n.target);t.parent().find("input").datepicker("show")}editLookup(n){const t=$(n.target),i=t.parent().find("input"),r=this.getRequest();this.lookup(i,r)}selectTime(n){const t=$(n.target);t.parent().find("input").timepicker("open");n.stopPropagation()}}