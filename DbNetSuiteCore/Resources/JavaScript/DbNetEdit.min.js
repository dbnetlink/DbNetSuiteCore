"use strict";class DbNetEdit extends DbNetGridEdit{constructor(n){super(n);this.browseDialogId="";this.changes={};this.currentRow=1;this.delete=!1;this.editMode="update";this.insert=!1;this.layoutColumns=1;this.primaryKey="";this.search=!0;this.totalRows=0;this.isEditDialog=!1;this.toolbarPosition==undefined&&(this.toolbarPosition="Bottom")}initialize(n=null){this.element&&(this.element.empty(),this.toolbarPosition=="Top"&&(this.toolbarPanel=this.addPanel("toolbar")),this.formPanel=this.addPanel("form"),this.toolbarPosition=="Bottom"&&(this.toolbarPanel=this.addPanel("toolbar")),this.addLoadingPanel(),n&&(this.primaryKey=n),this.post("initialize",this.getRequest()).then(n=>{n.error==!1&&(this.updateColumns(n),this.configureEdit(n),this.initialised=!0,this.fireEvent("onInitialized"))}),this.linkedControls.forEach(n=>{n.isBrowseDialog&&(this.browseDialogControl=n)}))}addLinkedControl(n){this.linkedControls.push(n)}getRows(n){this.callServer("search",n)}clearForm(){this.formElements().each(function(){const n=$(this);n.attr("type")=="checkbox"?n.prop("checked",!1).data("value",!1):n.val("").data("value","")})}disableForm(n,t=false){var i,r;this.initialised&&(this.clearForm(),this.formElements().not("[primarykey='true']").not("[datatype='Guid']").prop("disabled",n),(i=this.toolbarPanel)===null||i===void 0?void 0:i.find("button").prop("disabled",n),(r=this.toolbarPanel)===null||r===void 0?void 0:r.find("input").val(""),this.disable("SearchBtn",t),this.disable("InsertBtn",t),n&&this.configureLinkedControls(null,DbNetSuite.DBNull))}configureEdit(n){var t,i;this.toolbarPanel&&(n.toolbar&&((t=this.toolbarPanel)===null||t===void 0?void 0:t.html(n.toolbar)),this.configureToolbar(n));n.form&&((i=this.formPanel)===null||i===void 0?void 0:i.html(n.form),this.configureForm());this.updateForm(n)}configureForm(){var n,t,i,r,u;const f=(n=this.formPanel)===null||n===void 0?void 0:n.find(`:input[name]`);for(let n=0;n<f.length;n++){const t=$(f[n]);this.fireEvent("onFormElementCreated",{formElement:t[0],columnName:t.attr("name")})}(t=this.formPanel)===null||t===void 0?void 0:t.find("[button-type='calendar']").on("click",n=>this.selectDate(n));(i=this.formPanel)===null||i===void 0?void 0:i.find("[button-type='clock']").on("click",n=>this.selectTime(n));(r=this.formPanel)===null||r===void 0?void 0:r.find("[button-type='lookup']").on("click",n=>this.editLookup(n));(u=this.formPanel)===null||u===void 0?void 0:u.find("input[datatype='DateTime'").get().forEach(n=>{const t=$(n);this.addDatePicker(t,this.datePickerOptions)})}updateForm(n){var t,i;if(n.totalRows==0){this.disableForm(!0,!0);return}(t=this.formPanel)===null||t===void 0?void 0:t.find(":input").not("[primarykey='true']").not("[datatype='Guid']").prop("disabled",!1);const r=n.record;for(const n in r){const t=(i=this.formPanel)===null||i===void 0?void 0:i.find(`:input[name='${n}']`),u=r[n];if(t.attr("type")=="checkbox"){const n=u===!0;t.prop("checked",n).data("value",n)}else t.val(u.toString()).data("value",u.toString());(t.attr("primarykey")||t.attr("datatype")=="Guid")&&t.prop("disabled",!0)}const u=this.formElements().filter(":not(:disabled):first");u.trigger("focus");this.editMode="update";this.primaryKey=n.primaryKey;this.browseDialog&&this.browseDialog.isOpen()&&this.browseDialog.selectRow(this.currentRow);n.message&&this.message(n.message);this.configureLinkedControls(null,this.primaryKey);this.fireEvent("onFormUpdated",{formElements:this.formElements()})}callServer(n,t){this.post(n,this.getRequest()).then(n=>{n.error==!1&&(this.configureToolbar(n),this.updateForm(n)),t&&t(n)})}getRequest(){return{changes:this.changes,componentId:this.id,connectionString:this.connectionString,columns:this.columns.map(n=>n),currentRow:this.currentRow,culture:this.culture,fromPart:this.fromPart,layoutColumns:this.layoutColumns,navigation:this.navigation,quickSearch:this.quickSearch,quickSearchToken:this.quickSearchToken,search:this.search,searchFilterJoin:this.searchFilterJoin,searchParams:this.searchParams,totalRows:this.totalRows,primaryKey:this.primaryKey,isEditDialog:this.isEditDialog,insert:this.insert,"delete":this._delete,parentControlType:this.parentControlType,parentChildRelationship:this.parentChildRelationship}}configureToolbar(n){const t=this.controlElement("dbnetedit-toolbar").find(".navigation"),i=this.controlElement("no-records-cell"),r=this.isEditDialog?["Cancel","Apply"]:["First","Next","Previous","Last","Cancel","Apply","Search","Insert","Delete","Browse"];if(n.toolbar){r.forEach(n=>this.controlElement(`${n}Btn`).on("click",n=>this.handleClick(n)));this.controlElement("QuickSearch").on("keyup",n=>this.quickSearchKeyPress(n))}if(this.setInputElement("Rows",n.totalRows),this.configureToolbarButtons(!1),this.parentControlType&&this.parentChildRelationship=="OneToOne"){t.show();i.hide();return}n.totalRows==0?(t.hide(),i.show()):(t.show(),i.hide());this.controlElement("dbnetgrid-toolbar").find(".navigation").show();this.setInputElement("RowNumber",n.currentRow);this.setInputElement("RowCount",n.totalRows);this.currentRow=n.currentRow;this.totalRows=n.totalRows;this.disable("FirstBtn",n.currentRow==1);this.disable("PreviousBtn",n.currentRow==1);this.disable("NextBtn",n.currentRow==n.totalRows);this.disable("LastBtn",n.currentRow==n.totalRows);this.disable("BrowseBtn",n.totalRows<2);this.disable("DeleteBtn",n.totalRows==0);this.disable("ApplyBtn",n.totalRows==0);this.disable("CancelBtn",n.totalRows==0)}updateColumns(n){var t;this.columns=[];(t=n.columns)===null||t===void 0?void 0:t.forEach(n=>{const t={columnExpression:n.columnExpression,columnName:n.columnName,label:n.label,format:n.format,foreignKey:n.foreignKey,foreignKeyValue:n.foreignKeyValue,lookup:n.lookup,style:n.style,display:n.display,dataType:n.dataType,primaryKey:n.primaryKey,index:n.index,editControlType:n.editControlType,pattern:n.pattern,browse:n.browse};this.columns.push(new EditColumn(t))})}handleClick(n){const t=n.target.id;switch(t){case this.controlElementId("FirstBtn"):this.currentRow=1;break;case this.controlElementId("NextBtn"):this.currentRow++;break;case this.controlElementId("PreviousBtn"):this.currentRow--;break;case this.controlElementId("LastBtn"):this.currentRow=this.totalRows}n.preventDefault();switch(t){case this.controlElementId("SearchBtn"):this.openSearchDialog(this.getRequest());break;case this.controlElementId("BrowseBtn"):this.initBrowseDialog();break;case this.controlElementId("ApplyBtn"):this.applyChanges();break;case this.controlElementId("CancelBtn"):this.cancelChanges();break;case this.controlElementId("InsertBtn"):this.insertRecord();break;case this.controlElementId("DeleteBtn"):this.deleteRecord();break;default:this.getRecord()}}configureLinkedControl(n,t){if(n instanceof DbNetEdit){const i=n;if(t==DbNetSuite.DBNull){i.disableForm(!0,!0);return}i.parentChildRelationship=="OneToMany"&&(this.assignForeignKey(n,null,t),t=null);i.initialised?i.getRows():i.initialize(t)}}assignForeignKey(n,t,i=null){if(n instanceof DbNetEdit){const r=n,t=r.columns.find(n=>n.foreignKey==!0);if(t==undefined)return;t.foreignKeyValue=i?i:DbNetSuite.DBNull}}getRecord(n=null){n&&(this.primaryKey=n);this.callServer("getrecord")}insertRecord(){this.clearForm();const n=this;this.formElements().each(function(){const t=$(this);t.prop("disabled",!1);t.attr("primarykey")&&t.attr("autoincrement")&&t.prop("disabled",!0);t.attr("datatype")=="Guid"&&t.attr("required")&&(t.prop("disabled",!0),t.val(n.uuid()))});const t=this.formElements().filter(":not(:disabled):first");t.trigger("focus");this.editMode="insert";this.configureToolbarButtons(!0);this.configureLinkedControls(null,DbNetSuite.DBNull);this.fireEvent("onInsertInitalize",{formElements:this.formElements()})}configureToolbarButtons(n){const t=this.controlElement("dbnetedit-toolbar").find(".navigation"),i=["SearchBtn","QuickSearch","InsertBtn","DeleteBtn","BrowseBtn",],r=this.controlElement("no-records-cell");n?t.hide():t.show();n?r.hide():r.show();for(let t=0;t<i.length;t++){const r=this.controlElement(i[t]);n?r.hide():r.show()}n&&(this.controlElement("ApplyBtn").prop("disabled",!1),this.controlElement("CancelBtn").prop("disabled",!1))}formElements(){var n;if((n=this.formPanel)!==null&&n!==void 0)return n.find(":input.dbnetedit,select.dbnetedit")}deleteRecord(){this.confirm("Please confirm deletion of the current record",this.formPanel,n=>this.deletionConfirmed(n))}deletionConfirmed(n){n==MessageBoxButtonType.Confirm&&this.post("delete-record",this.getRequest()).then(n=>{n.error==!1&&this.recordDeleted()})}recordDeleted(){this.message("Record deleted");this.getRows();this.fireEvent("onRecordDeleted")}applyChanges(){const n={};let t=null;const i=this.formElements();if(i.filter("[required]").each(function(){var n;const t=$(this),i=(n=t.val())===null||n===void 0?void 0:n.toString().trim();i==""&&t.addClass("highlight")}),i.filter(".highlight").length>0){this.message("An entry in the highlighted field(s) is required");setTimeout(()=>this.clearHighlightedFields(),3e3);return}if(i.filter("[pattern]").each(function(){const n=$(this),i=n.attr("name");if(!this.reportValidity())return t={key:i,value:`Entry does not match the input pattern (${n.attr("pattern")})`},!1}),t!=null){this.message(t.value);this.highlightField(t.key.toLowerCase());return}(i.each(function(){const t=$(this),i=t.attr("name");t.attr("type")=="checkbox"?t.prop("checked")!=t.data("value")&&(n[i]=t.prop("checked")):t.val()!=t.data("value")&&(n[i]=t.val())}),$.isEmptyObject(n)!=!0)&&(this.changes=n,this.post(`${this.editMode}-record`,this.getRequest()).then(n=>{this.applyChangesCallback(n)}))}cancelChanges(){this.editMode=="insert"?this.getRows():this.getRecord()}applyChangesCallback(n){if(n.validationMessage){this.message(n.validationMessage.value);this.highlightField(n.validationMessage.key.toLowerCase());return}if(n.error){this.error(n.message);return}this.message(n.message);this.editMode=="update"?(this.updateForm(n),this.fireEvent("onRecordUpdated")):(this.isEditDialog==!1&&this.getRows(),this.fireEvent("onRecordInserted"))}initBrowseDialog(){var n,t,i,r;((n=this.browseDialogControl)===null||n===void 0?void 0:n.initialised)?this.openBrowseDialog():((t=this.browseDialogControl)===null||t===void 0?void 0:t.internalBind("onInitialized",()=>this.openBrowseDialog()),(i=this.browseDialogControl)===null||i===void 0?void 0:i.internalBind("onRowSelected",(n,t)=>this.browseDialogRowSelected(n,t)),(r=this.browseDialogControl)===null||r===void 0?void 0:r.initialize())}openBrowseDialog(){var n;this.browseDialog||(this.browseDialog=new BrowseDialog(this.browseDialogId,this,this.browseDialogControl));(n=this.browseDialog)===null||n===void 0?void 0:n.show(this.currentRow)}browseDialogRowSelected(n,t){t.row.rowIndex!=this.currentRow&&(this.currentRow=t.row.rowIndex,this.getRecord())}message(n){var t;(t=this.formPanel)===null||t===void 0?void 0:t.find(".message").html(n).addClass("highlight");setTimeout(()=>this.clearMessage(),3e3)}clearMessage(){var n;(n=this.formPanel)===null||n===void 0?void 0:n.find(".message").html("&nbsp;").removeClass("highlight")}highlightField(n){var t;(t=this.formPanel)===null||t===void 0?void 0:t.find(`[name='${n}']`).addClass("highlight");setTimeout(()=>this.clearHighlightedFields(),3e3)}clearHighlightedFields(){this.formElements().filter(".highlight").removeClass("highlight")}selectDate(n){const t=$(n.target);t.parent().find("input").datepicker("show")}editLookup(n){const t=$(n.target),i=t.parent().find("input"),r=this.getRequest();this.lookup(i,r)}selectTime(n){const t=$(n.target);t.parent().find("input").timepicker("open");n.stopPropagation()}uuid(){function n(n){let t;return n==="y"?(t=["8","9","a","b"],t[Math.floor(Math.random()*t.length)]):(t=new Uint8Array(1),window.crypto.getRandomValues(t),(t[0]%16).toString(16))}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n)}}