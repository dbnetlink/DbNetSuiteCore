"use strict";class DbNetEdit extends DbNetGridEdit{constructor(n){super(n);this.browseDialogId="";this.changes={};this.currentRow=1;this.delete=!1;this.editMode="update";this.insert=!1;this.layoutColumns=1;this.search=!0;this.totalRows=0;this.isEditDialog=!1;this.validationMessageType="Application";this.toolbarPosition==undefined&&(this.toolbarPosition="Bottom");this.maxImageHeight=100;this.formData=new FormData}initialize(n=null){this.element&&(this.element.empty(),this.editPanel=this.addPanel("form"),this.addLoadingPanel(),n&&(this.primaryKey=n),this.post("initialize",this.getRequest()).then(n=>{n.error==!1&&(this.updateColumns(n),this.configureEdit(n),this.initialised=!0,this.fireEvent("onInitialized"),n.message&&this.message(n.message))}),this.linkedControls.forEach(n=>{n.isBrowseDialog&&(this.browseControl=n,this.browseControl.internalBind("onRowSelected",(n,t)=>this.browseDialogRowSelected(n,t)),this.browseControl.internalBind("onPageLoaded",()=>this.browseControlReloaded()),this.browseControl.initialize())}))}getRows(n){this.post("search",this.getRequest()).then(t=>{t.error==!1&&(this.configureToolbar(t),this.updateForm(t),this.updateBrowseControl()),n&&n(t)})}columnValue(n){return this.formElements().filter(`:input[name='${n}']`).data("value")}setColumnValue(n,t){this.formElements().filter(`:input[name='${n}']`).val(t)}clearForm(){this.formElements().each(function(){const n=$(this);n.attr("type")=="checkbox"?n.prop("checked",!1).data("value",!1):n.val("").data("value","")});this.binaryElements().each(function(){const n=$(this);n.hide()})}disableForm(){var n,t,i;this.clearForm();(n=this.formPanel)===null||n===void 0?void 0:n.find("button").prop("disabled",!0);this.formElements().not("[primarykey='true']").not("[foreignkey='true']").not("[datatype='Guid']").prop("disabled",!0);(t=this.toolbarPanel)===null||t===void 0?void 0:t.find("button").prop("disabled",!0);(i=this.toolbarPanel)===null||i===void 0?void 0:i.find("input.toolbar-info").val("");this.disable("SearchBtn",this.parentControlType!="");this.disable("InsertBtn",this.parentControlType!="");this.disable("QuickSearch",this.parentControlType!="");this.initialised&&this.configureLinkedControls(null,DbNetSuite.DBNull)}configureEdit(n){var t,i,r,u;if(n.form){(t=this.editPanel)===null||t===void 0?void 0:t.html(n.form);this.formPanel=(i=this.editPanel)===null||i===void 0?void 0:i.find("table.dbnetedit-form");this.configureForm();const u=(r=this.editPanel)===null||r===void 0?void 0:r.find(".toolbar-container");this.toolbarPanel=this.addPanel("toolbar",u)}n.toolbar&&((u=this.toolbarPanel)===null||u===void 0?void 0:u.html(n.toolbar),this.configureToolbar(n));this.updateForm(n)}configureForm(){var n,t,i,r,u,f,e,o,s,h;const c=(n=this.formPanel)===null||n===void 0?void 0:n.find(`:input[name]`);for(let n=0;n<c.length;n++){const t=$(c[n]);this.fireEvent("onFormElementCreated",{formElement:t[0],columnName:t.attr("name")})}(t=this.formPanel)===null||t===void 0?void 0:t.find("[button-type='calendar']").on("click",n=>this.selectDate(n));(i=this.formPanel)===null||i===void 0?void 0:i.find("[button-type='lookup']").on("click",n=>this.editLookup(n));(r=this.formPanel)===null||r===void 0?void 0:r.find("[button-type='delete']").on("click",n=>this.deleteFile(n));(u=this.formPanel)===null||u===void 0?void 0:u.find("[button-type='upload']").on("click",n=>this.uploadFile(n));(f=this.formPanel)===null||f===void 0?void 0:f.find("img.dbnetedit").on("load",n=>this.imageLoaded(n));(e=this.formPanel)===null||e===void 0?void 0:e.find("img.dbnetedit").on("click",n=>this.viewImage(n));(o=this.formPanel)===null||o===void 0?void 0:o.find("select[dependentLookup]").on("change",n=>this.updateOptions(n));(s=this.formPanel)===null||s===void 0?void 0:s.find("input[texttransform]").on("input",n=>this.textTransform(n));(h=this.formPanel)===null||h===void 0?void 0:h.find("input[datatype='DateTime'").get().forEach(n=>{const t=$(n);this.addDatePicker(t,this.datePickerOptions)})}imageLoaded(n){var t;const i=$(n.currentTarget);i.show();((t=this.imageViewer)===null||t===void 0?void 0:t.isOpen())&&i.trigger("click")}updateForm(n){var t,i,r;if(n.totalRows==0){this.disableForm();return}(t=this.formPanel)===null||t===void 0?void 0:t.find(":input").not("[primarykey='true']").not("[foreignkey='true']").not("[datatype='Guid']").prop("disabled",!1);(i=this.formPanel)===null||i===void 0?void 0:i.find("button").prop("disabled",!1);const u=n.record;for(const n in u){const t=(r=this.formPanel)===null||r===void 0?void 0:r.find(`:input[name='${n}']`);if(t.length!=0){const i=u[n];if(t.attr("isDependentLookup")){t.empty();t.data("value",i.toString());continue}if(t.attr("type")=="checkbox"){const n=i===!0;t.prop("checked",n).data("value",n)}else t.val(i.toString()).data("value",i.toString());(t.attr("primarykey")||t.attr("foreignkey")||t.attr("datatype")=="Guid")&&t.prop("disabled",!0)}}for(let n=0;n<this.formElements().length;n++){const t=this.formElements().eq(n);t.attr("dependentLookup")&&!t.attr("isDependentLookup")&&t.val()!=""&&this.refreshOptions(t.attr("dependentLookup"),t.val())}const f=["range","color"];for(let n=0;n<f.length;n++)this.formElements().filter(`:input[type='${f[n]}']`).trigger("change");const e=this.formElements().filter(":not(:disabled):first");e.trigger("focus");this.editMode="update";this.primaryKey=n.primaryKey;this.formData=new FormData;const o=this;this.binaryElements().each(function(){const n=$(this);o.configureBinaryData(n,u)});this.browseDialog&&this.browseDialog.isOpen()&&this.browseDialog.selectRow(this.currentRow);n.message&&this.message(n.message);this.configureLinkedControls(null,this.primaryKey);this.fireEvent("onRecordSelected",{formElements:this.formElements(),binaryElements:this.binaryElements()})}updateOptions(n){var t;const i=$(n.target),r=i.attr("dependentLookup"),u=(t=this.formPanel)===null||t===void 0?void 0:t.find(`:input[name='${r.toLowerCase()}']`);u.data("value","");this.refreshOptions(r,i.val())}textTransform(n){const t=n.target,i=t.selectionStart;switch($(t).attr("texttransform")){case"Uppercase":t.value=t.value.toUpperCase();break;case"Lowercase":t.value=t.value.toLowerCase();break;case"Capitalize":t.value=this.toTitleCase(t.value)}t.setSelectionRange(i,i)}toTitleCase(n){return n.toLowerCase().split(" ").map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" ")}refreshOptions(n,t){var r;const i=(r=this.formPanel)===null||r===void 0?void 0:r.find(`:input[name='${n.toLowerCase()}']`),u=this.getRequest();u.lookupColumnIndex=parseInt(i.attr("columnIndex"));u.lookupParameterValue=t;this.post("get-options",u).then(r=>{i.html(r.html),i.val(i.data("value")),i.attr("dependentLookup")!=null&&(n=i.attr("dependentLookup"),t=i.data("value"),this.refreshOptions(n,t))})}callServer(n,t){this.post(n,this.getRequest()).then(n=>{n.error==!1&&(this.configureToolbar(n),this.updateForm(n)),t&&t(n)})}getRequest(){const n=this.baseRequest();return n.changes=this.changes,n.columns=this.columns.map(n=>n),n.currentRow=this.currentRow,n.layoutColumns=this.layoutColumns,n.totalRows=this.totalRows,n.isEditDialog=this.isEditDialog,n.toolbarPosition=this.toolbarPosition,n}configureToolbar(n){const t=this.controlElement("dbnetedit-toolbar").find(".navigation"),i=this.controlElement("no-records-cell"),r=this.isEditDialog?["Cancel","Apply"]:["First","Next","Previous","Last","Cancel","Apply","Search","Insert","Delete","Browse"];if(n.toolbar){r.forEach(n=>this.controlElement(`${n}Btn`).on("click",n=>this.handleClick(n)));this.controlElement("QuickSearch").on("keyup",n=>this.quickSearchKeyPress(n))}if(this.setInputElement("Rows",n.totalRows),this.configureToolbarButtons(!1,n.totalRows),this.parentControlType&&this.parentChildRelationship=="OneToOne"){t.show();i.hide();return}n.totalRows==0?(t.hide(),i.show()):(t.show(),i.hide());this.controlElement("dbnetgrid-toolbar").find(".navigation").show();this.setInputElement("RowNumber",n.currentRow);this.setInputElement("RowCount",n.totalRows);this.currentRow=n.currentRow;this.totalRows=n.totalRows;this.disable("SearchBtn",!1);this.disable("InsertBtn",!1);this.disable("QuickSearch",!1);this.disable("FirstBtn",n.currentRow==1);this.disable("PreviousBtn",n.currentRow==1);this.disable("NextBtn",n.currentRow==n.totalRows);this.disable("LastBtn",n.currentRow==n.totalRows);this.disable("BrowseBtn",n.totalRows<2);this.linkedGridOrEdit()==!1&&this.disable("DeleteBtn",n.totalRows==0);this.disable("DeleteBtn",n.totalRows==0);this.disable("ApplyBtn",n.totalRows==0);this.disable("CancelBtn",n.totalRows==0);this.parentGridOrEdit()&&this.configureParentDeleteButton(n.totalRows>0)}updateColumns(n){var t;this.columns=[];(t=n.columns)===null||t===void 0?void 0:t.forEach(n=>{const t={columnExpression:n.columnExpression,columnName:n.columnName,label:n.label,format:n.format,foreignKey:n.foreignKey,foreignKeyValue:n.foreignKeyValue,lookup:n.lookup,style:n.style,display:n.display,dataType:n.dataType,primaryKey:n.primaryKey,index:n.index,editControlType:n.editControlType,pattern:n.pattern,browse:n.browse,search:n.search,autoIncrement:n.autoIncrement,annotation:n.annotation,placeholder:n.placeholder,inputValidation:n.inputValidation,textTransform:n.textTransform};this.columns.push(new EditColumn(t))})}handleClick(n){const t=n.target.id;switch(t){case this.controlElementId("FirstBtn"):this.currentRow=1;break;case this.controlElementId("NextBtn"):this.currentRow++;break;case this.controlElementId("PreviousBtn"):this.currentRow--;break;case this.controlElementId("LastBtn"):this.currentRow=this.totalRows}n.preventDefault();switch(t){case this.controlElementId("SearchBtn"):this.openSearchDialog(this.getRequest());break;case this.controlElementId("BrowseBtn"):this.openBrowseDialog();break;case this.controlElementId("ApplyBtn"):this.applyChanges();break;case this.controlElementId("CancelBtn"):this.cancelChanges();break;case this.controlElementId("InsertBtn"):this.insertRecord();break;case this.controlElementId("DeleteBtn"):this.deleteRecord();break;default:this.getRecord()}}configureLinkedControl(n,t){if(n instanceof DbNetEdit){const i=n;if(t==DbNetSuite.DBNull){i.disableForm();return}i.parentChildRelationship=="OneToMany"&&(this.assignForeignKey(n,t),t=null);i.initialised?i.getRows():i.initialize(t)}if(n instanceof DbNetGrid){const i=n;i.isBrowseDialog==!1&&(this.assignForeignKey(i,t),i.currentPage=1,i.initialised?i.getPage():i.initialize())}}getRecord(n=null){n&&(this.primaryKey=n);this.callServer("getrecord")}insertRecord(){var n;this.clearForm();const t=this;this.formElements().each(function(){const n=$(this);n.prop("disabled",!1);n.attr("primarykey")&&n.attr("autoincrement")&&n.prop("disabled",!0);n.attr("foreignkey")&&n.prop("disabled",!0);n.attr("datatype")=="Guid"&&n.attr("required")&&(n.prop("disabled",!0),n.val(t.uuid()));n.attr("initialvalue")&&n.val(n.attr("initialvalue"));n.attr("isDependentLookup")&&n.empty()});(n=this.formPanel)===null||n===void 0?void 0:n.find("button").prop("disabled",!1);const i=this.formElements().filter(":not(:disabled):first");i.trigger("focus");this.editMode="insert";this.configureToolbarButtons(!0);this.configureLinkedControls(null,DbNetSuite.DBNull);this.fireEvent("onInsertInitalize",{formElements:this.formElements()})}updateForeignKeyValue(n){this.formElements().filter("[foreignkey='true']").attr("initialvalue",n===null||n===void 0?void 0:n.toString())}configureToolbarButtons(n,t=0){const i=this.controlElement("dbnetedit-toolbar").find(".navigation"),r=["SearchBtn","QuickSearch","InsertBtn","DeleteBtn","BrowseBtn",],u=this.controlElement("no-records-cell");n?i.hide():i.show();n?u.hide():u.show();for(let t=0;t<r.length;t++){const i=this.controlElement(r[t]);n?i.hide():i.show()}const f=!n&&t==0;this.controlElement("ApplyBtn").prop("disabled",f);this.controlElement("CancelBtn").prop("disabled",f)}formElements(){var n;if((n=this.formPanel)!==null&&n!==void 0)return n.find(":input.dbnetedit,select.dbnetedit,textarea.dbnetedit")}binaryElements(){var n;if((n=this.formPanel)!==null&&n!==void 0)return n.find("img.dbnetedit,a.dbnetedit")}primaryKeyCheck(){return this.primaryKey==null?(this.error("A primary key has not been included in the edit columns"),!1):!0}deleteRecord(){this.primaryKeyCheck()&&this.confirm("Please confirm deletion of the current record",this.formPanel,n=>this.deletionConfirmed(n))}deletionConfirmed(n){n==MessageBoxButtonType.Confirm&&this.post("delete-record",this.getRequest()).then(n=>{n.error==!1?this.recordDeleted():this.error(n.message)})}recordDeleted(){this.message("Record deleted");this.getRows();this.fireEvent("onRecordDeleted")}applyChanges(){if(this.editMode!="update"||this.primaryKeyCheck()){const t={};let n=null;const i=this.formElements();if(i.filter("[required]").each(function(){var n;const t=$(this),i=(n=t.val())===null||n===void 0?void 0:n.toString().trim();i==""&&t.addClass("highlight")}),i.filter(".highlight").length>0){this.message("An entry in the highlighted field(s) is required");setTimeout(()=>this.clearHighlightedFields(),3e3);return}if(i.each(function(){const t=this,i=$(t),r=i.attr("name");if(!t.checkValidity())return n={key:r,value:t.validationMessage},!1}),n!=null){this.fireEvent("onFormElementValidationFailed",n);const t=n.key.toLowerCase();this.validationMessageType=="Native"?this.formElement(t).get(0).reportValidity():(this.message(n.value),this.highlightField(t));return}(i.each(function(){const n=$(this),i=n.attr("name");n.attr("type")=="checkbox"?n.prop("checked")!=n.data("value")&&(t[i]=n.prop("checked")):n.val()!=n.data("value")&&(t[i]=n.val())}),$.isEmptyObject(t)!=!0||this.hasFormData()!=!1)&&(this.changes=t,this.hasFormData()?this.post("save-files",this.formData).then(n=>{this.submitChanges(n)}):this.submitChanges(null))}}submitChanges(n){const t=this.getRequest();n&&(t.formCacheKey=n.formCacheKey);this.post(`${this.editMode}-record`,t).then(n=>{this.applyChangesCallback(n)})}cancelChanges(){this.editMode=="insert"?this.getRows():this.getRecord()}applyChangesCallback(n){if(n.validationMessage){this.message(n.validationMessage.value);this.highlightField(n.validationMessage.key.toLowerCase());return}if(n.error){this.error(n.message);return}this.message(n.message);this.editMode=="update"?(this.updateForm(n),this.fireEvent("onRecordUpdated")):(this.isEditDialog==!1&&this.getRows(),this.fireEvent("onRecordInserted"))}updateBrowseControl(){this.browseControl&&this.browseControl.initialised!=!1&&(this.browseControl.quickSearchToken=this.quickSearchToken,this.browseControl.searchParams=this.searchParams,this.browseControl.reload())}browseControlReloaded(){var n;((n=this.browseDialog)===null||n===void 0?void 0:n.isOpen())&&this.browseDialog.selectRow(this.currentRow)}openBrowseDialog(){var n;this.browseDialog||(this.browseDialog=new BrowseDialog(this.browseDialogId,this.browseControl));(n=this.browseDialog)===null||n===void 0?void 0:n.show(this.currentRow)}browseDialogRowSelected(n,t){t.row.rowIndex!=this.currentRow&&(this.currentRow=t.row.rowIndex,this.getRecord())}message(n){var t;(t=this.editPanel)===null||t===void 0?void 0:t.find(".message").html(n).addClass("highlight");setTimeout(()=>this.clearMessage(),3e3)}clearMessage(){var n;(n=this.editPanel)===null||n===void 0?void 0:n.find(".message").html("&nbsp;").removeClass("highlight")}formElement(n){return this.formElements().filter(`[name='${n}']`)}highlightField(n){this.formElement(n).addClass("highlight");setTimeout(()=>this.clearHighlightedFields(),3e3)}clearHighlightedFields(){this.formElements().filter(".highlight").removeClass("highlight")}selectDate(n){const t=$(n.target),i=t.parent().find("input");i.attr("readonly")||i.prop("disabled")==!0||t.parent().find("input").datepicker("show")}editLookup(n){const t=$(n.target),i=t.parent().find("input"),r=this.getRequest();this.lookup(i,r)}uploadFile(n){if(this.uploadDialog){this.uploadDialog.show(n);return}this.post("upload-dialog",this.getRequest()).then(t=>{var i;(i=this.element)===null||i===void 0?void 0:i.append(t.dialog);this.uploadDialog=new UploadDialog(`${this.id}_upload_dialog`,this);this.uploadDialog.show(n)})}deleteFile(n){const t=$(n.currentTarget).closest("td").find("img");this.saveFile(t,null)}uuid(){function n(n){let t;return n==="y"?(t=["8","9","a","b"],t[Math.floor(Math.random()*t.length)]):(t=new Uint8Array(1),window.crypto.getRandomValues(t),(t[0]%16).toString(16))}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n)}configureBinaryData(n,t){const i=n.attr("name"),f=t[i];if(f.toString().replace("0","")==""){n.hide();return}let r=this.getFileName(i);r||(r="");const u={element:n.get(0),fileName:r,columnName:this.columnName,record:t};if(this.fireEvent("onConfigureBinaryData",u),n.data("filename",u.fileName),n.attr("isimage")=="true")this.columnName=i,this.post("download-column-data",this.getRequest(),!0).then(t=>{t.size&&(n.attr("src",window.URL.createObjectURL(t)),n.show())});else{n.attr("href","javascript:void(0)");n.text("Download");n.show();n.off().on("click",n=>this.downloadFile(n))}}getFileName(n){return this.formElements().filter(`[uploadmetadatacolumn='${n}'][uploadmetadata='FileName']`).val()}downloadFile(n){const t=$(n.currentTarget);this.columnName=t.attr("name");let i=t.data("filename");if(!i){const n=t.attr("extensions").split(",")[0];i=`download${n}`}this.post("download-column-data",this.getRequest(),!0).then(n=>{if(n.size){t.off();const r=t.get(0);r.href=window.URL.createObjectURL(n);r.download=i;r.click()}})}saveFile(n,t,i=null){n.prop("tagName")=="A"&&(n.text(i===null||i===void 0?void 0:i.fileName),n.attr("href",null));t?n.show():n.hide();const r=n.attr("name");this.formData.get(r)!=null&&this.formData.delete(r);t?this.formData.append(r,t):this.formData.append(r,new Blob);const u=this.formElements().filter(`:input[uploadmetadatacolumn='${r}']`),f=this;u.each(function(){const n=$(this);if(!t){n.val("");return}switch(n.attr("uploadmetadata")){case"FileName":n.val(i===null||i===void 0?void 0:i.fileName);break;case"Size":n.val(i===null||i===void 0?void 0:i.size);break;case"LastModified":f.applyLastModified(n,i===null||i===void 0?void 0:i.lastModified);break;case"ContentType":n.val(i===null||i===void 0?void 0:i.contentType)}});this.fireEvent("onFileSelected",{element:n,fileMetaData:i})}applyLastModified(n,t){const i=this.getRequest();i.javascriptDate=t;i.columnName=n.attr("name");this.post("convert-date",i).then(t=>{n.val(t.convertedDate)})}hasFormData(){let n=!1;for(const t of this.formData.keys()){n=!0;break}return n}}