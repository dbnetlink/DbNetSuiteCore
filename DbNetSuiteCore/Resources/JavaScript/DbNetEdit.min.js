"use strict";class DbNetEdit extends DbNetGridEdit{constructor(n){super(n);this.applychanges="applychanges";this.changes={};this.currentRow=1;this.delete=!1;this.insert=!1;this.layoutColumns=1;this.primaryKey="";this.search=!0;this.totalRows=0;this.isEditDialog=!1;this.toolbarPosition==undefined&&(this.toolbarPosition="Bottom")}initialize(){this.element&&(this.element.empty(),this.toolbarPosition=="Top"&&(this.toolbarPanel=this.addPanel("toolbar")),this.formPanel=this.addPanel("form"),this.toolbarPosition=="Bottom"&&(this.toolbarPanel=this.addPanel("toolbar")),this.addLoadingPanel(),this.post("initialize",this.getRequest()).then(n=>{n.error==!1&&(this.updateColumns(n),this.configureEdit(n),this.initialised=!0,this.fireEvent("onInitialized"))}))}addLinkedControl(n){this.linkedControls.push(n)}getRows(n){this.callServer("search",n)}configureEdit(n){var t,i;this.toolbarPanel&&(n.toolbar&&((t=this.toolbarPanel)===null||t===void 0?void 0:t.html(n.toolbar)),this.configureToolbar(n));n.form&&((i=this.formPanel)===null||i===void 0?void 0:i.html(n.form),this.configureForm());this.updateForm(n)}configureForm(){var n,t,i,r,u;const f=(n=this.formPanel)===null||n===void 0?void 0:n.find(`:input[name]`);for(let n=0;n<f.length;n++){const t=$(f[n]);this.fireEvent("onFormElementCreated",{formElement:t[0],columnName:t.attr("name")})}(t=this.formPanel)===null||t===void 0?void 0:t.find("[button-type='calendar']").on("click",n=>this.selectDate(n));(i=this.formPanel)===null||i===void 0?void 0:i.find("[button-type='clock']").on("click",n=>this.selectTime(n));(r=this.formPanel)===null||r===void 0?void 0:r.find("[button-type='lookup']").on("click",n=>this.editLookup(n));(u=this.formPanel)===null||u===void 0?void 0:u.find("input[datatype='DateTime'").get().forEach(n=>{const t=$(n);this.addDatePicker(t,this.datePickerOptions)})}updateForm(n){var t,i,r;if(n.totalRows==0){(t=this.formPanel)===null||t===void 0?void 0:t.find(":input").val("").not("[primarykey='true']").prop("checked",!1).prop("selected",!1).prop("disabled",!0);return}(i=this.formPanel)===null||i===void 0?void 0:i.find(":input").not("[primarykey='true']").prop("disabled",!1);const u=n.record;for(const n in u){const t=(r=this.formPanel)===null||r===void 0?void 0:r.find(`:input[name='${n}']`),i=u[n];if(t.attr("type")=="checkbox"){const n=i===!0;t.prop("checked",n).data("value",n)}else t.val(i.toString()).data("value",i.toString());t.attr("primarykey")&&t.prop("disabled",!0)}this.editMode("update");this.primaryKey=n.primaryKey;n.message&&this.message(n.message)}callServer(n,t){this.post(n,this.getRequest()).then(n=>{n.error==!1&&(this.configureToolbar(n),this.updateForm(n)),t&&t(n)})}getRequest(){return{changes:this.changes,componentId:this.id,connectionString:this.connectionString,columns:this.columns.map(n=>n),currentRow:this.currentRow,culture:this.culture,fromPart:this.fromPart,layoutColumns:this.layoutColumns,navigation:this.navigation,quickSearch:this.quickSearch,quickSearchToken:this.quickSearchToken,search:this.search,searchFilterJoin:this.searchFilterJoin,searchParams:this.searchParams,totalRows:this.totalRows,primaryKey:this.primaryKey,isEditDialog:this.isEditDialog,insert:this.insert,"delete":this._delete}}configureToolbar(n){const t=this.controlElement("dbnetedit-toolbar").find(".navigation"),i=this.controlElement("no-records-cell");if(n.toolbar){const n=this.isEditDialog?["Cancel","Apply"]:["First","Next","Previous","Last","Cancel","Apply","Search","Insert","Delete"];n.forEach(n=>this.controlElement(`${n}Btn`).on("click",n=>this.handleClick(n)))}this.setInputElement("Rows",n.totalRows);this.controlElement("SearchBtn").show();this.controlElement("QuickSearch").show();this.controlElement("InsertBtn").show();n.totalRows==0?(t.hide(),i.show()):this.isEditDialog==!1?(t.show(),i.hide(),this.controlElement("dbnetgrid-toolbar").find(".navigation").show(),this.setInputElement("RowNumber",n.currentRow),this.setInputElement("RowCount",n.totalRows),this.currentRow=n.currentRow,this.totalRows=n.totalRows,this.disable("FirstBtn",n.currentRow==1),this.disable("PreviousBtn",n.currentRow==1),this.disable("NextBtn",n.currentRow==n.totalRows),this.disable("LastBtn",n.currentRow==n.totalRows),this.controlElement("DeleteBtn").show()):(t.show(),i.hide());this.controlElement("QuickSearch").on("keyup",n=>this.quickSearchKeyPress(n))}updateColumns(n){var t;this.columns=[];(t=n.columns)===null||t===void 0?void 0:t.forEach(n=>{const t={columnExpression:n.columnExpression,columnName:n.columnName,label:n.label,format:n.format,foreignKey:n.foreignKey,foreignKeyValue:n.foreignKeyValue,lookup:n.lookup,style:n.style,display:n.display,dataType:n.dataType,primaryKey:n.primaryKey,index:n.index,editControlType:n.editControlType,pattern:n.pattern};this.columns.push(new EditColumn(t))})}handleClick(n){const t=n.target.id;switch(t){case this.controlElementId("FirstBtn"):this.currentRow=1;break;case this.controlElementId("NextBtn"):this.currentRow++;break;case this.controlElementId("PreviousBtn"):this.currentRow--;break;case this.controlElementId("LastBtn"):this.currentRow=this.totalRows}n.preventDefault();switch(t){case this.controlElementId("SearchBtn"):this.openSearchDialog(this.getRequest());break;case this.controlElementId("ApplyBtn"):this.applyChanges();break;case this.controlElementId("InsertBtn"):this.insertRecord();break;case this.controlElementId("DeleteBtn"):this.deleteRecord();break;default:this.getRecord()}}getRecord(n=null){n&&(this.primaryKey=n);this.callServer("getrecord")}insertRecord(){var n,t;(n=this.formPanel)===null||n===void 0?void 0:n.find(":input.dbnetedit,select.dbnetedit").each(function(){const n=$(this);n.attr("type")=="checkbox"?n.prop("checked",!1).data("value",!1):n.val("").data("value","");n.attr("primarykey")&&n.attr("autoincrement")==null&&n.prop("disabled",!1)});const i=(t=this.formPanel)===null||t===void 0?void 0:t.find(":input.dbnetedit,select.dbnetedit").filter(":not(:disabled):first");i.trigger("focus");this.editMode("insert");this.controlElement("dbnetedit-toolbar").find(".navigation").hide();this.controlElement("SearchBtn").hide();this.controlElement("QuickSearch").hide();this.controlElement("InsertBtn").hide();this.controlElement("DeleteBtn").hide()}deleteRecord(n=null){n&&(this.primaryKey=n);this.callServer("getrecord")}applyChanges(){var i;const t={};let n=null;if((i=this.formPanel)===null||i===void 0?void 0:i.find(":input.dbnetedit,select.dbnetedit").each(function(){var u;const i=$(this),r=i.attr("name");if(i.attr("type")=="checkbox")i.prop("checked")!=i.data("value")&&(t[r]=i.prop("checked"));else{const f=(u=i.val())===null||u===void 0?void 0:u.toString().trim();if(i.attr("required")&&f=="")return n={key:r,value:`An entry in this field is required)`},!1;if(i.attr("pattern")){const t=i[0].reportValidity();if(!t)return n={key:r,value:`Entry does not match the input pattern (${i.attr("pattern")})`},!1}i.val()!=i.data("value")&&(t[r]=i.val())}}),n!=null){this.message(n.value);this.highlightField(n.key.toLowerCase());return}$.isEmptyObject(t)!=!0&&(this.changes=t,this.post(`${this.editMode()}-record`,this.getRequest()).then(n=>{n.error==!1&&this.applyChangesCallback(n)}))}editMode(n=null){var t,i;return n?((t=this.formPanel)===null||t===void 0?void 0:t.attr("mode",n),""):(i=this.formPanel)===null||i===void 0?void 0:i.attr("mode")}applyChangesCallback(n){if(n.validationMessage){this.message(n.validationMessage.value);this.highlightField(n.validationMessage.key.toLowerCase());return}this.editMode()=="update"?(this.updateForm(n),this.fireEvent("onRecordUpdated")):(this.isEditDialog==!1&&this.getRows(),this.fireEvent("onRecordInserted"))}message(n){var t;(t=this.formPanel)===null||t===void 0?void 0:t.find(".message").html(n).addClass("highlight");setInterval(()=>this.clearMessage(),3e3)}clearMessage(){var n;(n=this.formPanel)===null||n===void 0?void 0:n.find(".message").html("&nbsp;").removeClass("highlight")}highlightField(n){var t;const i=(t=this.formPanel)===null||t===void 0?void 0:t.find(`[name='${n}']`).addClass("highlight");setInterval(()=>this.clearHighlightField(i),3e3)}clearHighlightField(n){n.removeClass("highlight")}selectDate(n){const t=$(n.target);t.parent().find("input").datepicker("show")}editLookup(n){const t=$(n.target),i=t.parent().find("input"),r=this.getRequest();this.lookup(i,r)}selectTime(n){const t=$(n.target);t.parent().find("input").timepicker("open");n.stopPropagation()}}