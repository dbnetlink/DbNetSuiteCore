"use strict";class DbNetFile extends DbNetSuite{constructor(n){super(n);this.rootFolder="";this.fileName="";this.folder="";this.quickSearch=!0;this.quickSearchToken="";this.toolbarButtonStyle=ToolbarButtonStyle.Image;this.search=!0;this.searchFilterJoin="";this.searchParams=[];this.export=!0;this.copy=!0;this.upload=!1;this.navigation=!0;this.totalRows=0;this.totalPages=0;this.currentPage=1;this.pageSize=20;this.previewHeight=30;this.caption="";this.nested=!1;this.orderBy="";this.orderByDirection="asc";this.searchResultsDialogId="";this.isSearchResults=!1;this.includeSubfolders=!1;this.treeView=!1;this.filesOnly=!1;this.columns=[]}initialize(){this.element&&(this.rootFolder=this.folder,this.element.empty(),this.toolbarPanel=this.addPanel("toolbar"),this.folderPanel=this.addPanel("folder"),this.addLoadingPanel(),this.callServer("initialise"),this.initialised=!0,this.fireEvent("onInitialized"),this.linkedControls.forEach(n=>{n.isSearchResults&&(this.searchResultsControl=n,this.searchResultsControl.internalBind("onPageLoaded",()=>this.openSearchResultsDialog()))}),this.configureLinkedControls(this.folder))}setColumnTypes(...n){n.forEach(n=>{this.columns.push(new FileColumn(n))})}setColumnProperty(n,t,i){let r=this.columns.find(t=>t.type==n);r==undefined&&(r=new FileColumn(n),this.columns.push(r));r[t]=i}reload(){this.initialised?(this.currentPage=1,this.getPage()):this.initialize()}getPage(n){this.callServer("page",n)}configureToolbar(n){if(n.toolbar)["First","Next","Previous","Last","Export","Copy","Search","Upload"].forEach(n=>this.addEventListener(`${n}Btn`));const t=this.controlElement("dbnetfile-toolbar").find(".navigation"),i=this.controlElement("no-records-cell");this.setInputElement("Rows",n.totalRows);this.totalRows=n.totalRows;n.totalRows==0?(t.hide(),i.show()):(t.show(),i.hide(),this.controlElement("dbnetfile-toolbar").find(".navigation").show(),this.setInputElement("PageNumber",n.currentPage),this.setInputElement("PageCount",n.totalPages),this.currentPage=n.currentPage,this.totalPages=n.totalPages,this.disable("FirstBtn",n.currentPage==1),this.disable("PreviousBtn",n.currentPage==1),this.disable("NextBtn",n.currentPage==n.totalPages),this.disable("LastBtn",n.currentPage==n.totalPages));this.controlElement("QuickSearch").on("keyup",n=>this.quickSearchKeyPress(n));this.disable("ExportBtn",n.totalRows==0);this.disable("CopyBtn",n.totalRows==0);this.disable("UpdateBtn",n.totalRows==0)}configurePage(n){var t,i,r,u,f,e,o,s;this.toolbarPanel&&(n.toolbar&&((t=this.toolbarPanel)===null||t===void 0?void 0:t.html(n.toolbar)),this.configureToolbar(n));(i=this.folderPanel)===null||i===void 0?void 0:i.html(n.html);(r=this.folderPanel)===null||r===void 0?void 0:r.find("a.folder-link").get().forEach(n=>{$(n).on("click",n=>this.selectFolder(n))});(u=this.folderPanel)===null||u===void 0?void 0:u.find("td.folder").get().forEach(n=>{$(n).on("click",n=>this.openNestedFolder(n))});(f=this.folderPanel)===null||f===void 0?void 0:f.find("a.file-link").get().forEach(n=>{$(n).on("click",n=>this.selectFile(n))});(e=this.folderPanel)===null||e===void 0?void 0:e.find("tr.data-row").get().forEach(n=>{this.addRowEventHandlers($(n))});(o=this.folderPanel)===null||o===void 0?void 0:o.find("tr.header-row th").get().forEach(n=>{$(n).on("click",()=>this.handleHeaderClick($(n)))});(s=this.folderPanel)===null||s===void 0?void 0:s.find("td[column-type='Preview']").get().forEach(n=>this.loadPreview($(n)));this.fireEvent("onPageLoaded",{})}configureTreeView(n){var t,i,r;(t=this.folderPanel)===null||t===void 0?void 0:t.html(n.html);(i=this.folderPanel)===null||i===void 0?void 0:i.find("span.subfolders").on("click",n=>this.openCloseFolder(n));(r=this.folderPanel)===null||r===void 0?void 0:r.find("a.folder-link").on("click",n=>this.selectTreeFolder(n));this.fireEvent("onPageLoaded",{})}selectTreeFolder(n){n.stopPropagation();const t=$(n.currentTarget);this.configureLinkedControls(t.data("folder"))}configureLinkedControl(n,t){n.isSearchResults||(n.folder=t.toString(),n.reload())}openCloseFolder(n){n.stopPropagation();const t=$(n.currentTarget),i=t.parent();if(!i.hasClass("root")){const r=i.children("ul").first();t.toggleClass("open");r.toggleClass("hidden")}}selectFolder(n){const t=$(n.currentTarget);if(this.isSearchResults){const n=this.parentControl;n.folder=t.data("folder");n.reload()}else this.folder=t.data("folder"),this.currentPage=1,this.callServer("page")}loadPreview(n){const t=n.parent().find("a[data-filetype='Image']");t&&(this.fileName=t.data("file"),this.post("download-file",this.getRequest(),!0).then(t=>{if(t.size){const i=$(new Image);i.hide();i.attr("src",window.URL.createObjectURL(t));i.on("load",n=>this.setPreviewHeight(n));n.empty().append(i)}}))}setPreviewHeight(n){const t=$(n.currentTarget),i=t===null||t===void 0?void 0:t.height();i>this.previewHeight&&t.height(this.previewHeight);t.show()}selectFile(n){const t=$(n.currentTarget);this.fileName=t.data("file");const i=t.data("filetype"),r=t.text();this.post("download-file",this.getRequest(),!0).then(n=>{if(n.size)switch(i){case"Image":case"Video":case"Audio":this.viewUrl(window.URL.createObjectURL(n),r,i);break;case"Html":case"Pdf":this.viewInTab(n);break;default:this.downloadBlob(n,r)}})}addRowEventHandlers(n){n.on("mouseover",n=>$(n.currentTarget).addClass("highlight"));n.on("mouseout",n=>$(n.currentTarget).removeClass("highlight"));n.on("click",n=>this.handleRowClick($(n.currentTarget)))}handleRowClick(n){n.parent().find("tr.data-row").removeClass("selected");n.addClass("selected");this.fireEvent("onRowSelected",{row:n[0]})}handleHeaderClick(n){this.orderBy=n.data("type");this.orderByDirection="asc";n.attr("orderby")&&(this.orderByDirection=n.attr("orderby")=="asc"?"desc":"asc");this.getPage()}downloadBlob(n,t){const i=document.createElement("a");i.href=window.URL.createObjectURL(n);i.download=t;i.click()}viewInTab(n){const t=document.createElement("a");t.href=window.URL.createObjectURL(n);t.target="_blank";t.click()}openNestedFolder(n){const t=$(n.currentTarget),i=t.closest("tr");if(t.hasClass("open")){t.removeClass("open");i.next().hide();return}const o=t.closest("table");if(t.addClass("open"),i.next().hasClass("nested-component-row")){i.next().show();return}const r=o[0].insertRow(i[0].rowIndex+1);r.className="nested-component-row";r.insertCell(-1);const u=r.insertCell(-1);u.className="nested-component-cell";u.colSpan=i[0].cells.length-1;const e=`dbnetfile${(new Date).valueOf()}`;jQuery(document.createElement("div")).attr("id",e).appendTo($(u));const f=new DbNetFile(e);f.folder=t.data("folder");f.nested=!0;f.initialize()}callServer(n,t){this.post(n,this.getRequest()).then(n=>{t?t(n):n.error==!1&&(this.treeView?this.configureTreeView(n):this.configurePage(n))})}addEventListener(n,t="click"){this.controlElement(n).on(t,n=>this.handleClick(n))}handleClick(n){const t=n.target.id;switch(t){case this.controlElementId("FirstBtn"):this.currentPage=1;break;case this.controlElementId("NextBtn"):this.currentPage++;break;case this.controlElementId("PreviousBtn"):this.currentPage--;break;case this.controlElementId("LastBtn"):this.currentPage=this.totalPages}n.preventDefault();switch(t){case this.controlElementId("ExportBtn"):this.download();break;case this.controlElementId("CopyBtn"):this.copyGrid();break;case this.controlElementId("SearchBtn"):this.openSearchDialog(this.getRequest());break;case this.controlElementId("UploadBtn"):break;default:this.getPage()}}applySearch(n,t){this.searchResultsControl&&(this.searchResultsControl.searchFilterJoin=n,this.searchResultsControl.includeSubfolders=t,this.searchResultsControl.folder=this.folder,this.searchResultsControl.searchParams=this.searchParams,this.searchResultsControl.reload())}openSearchResultsDialog(){var n;this.searchResultsDialog||(this.searchResultsDialog=new SearchResultsDialog(this.searchResultsDialogId,this.searchResultsControl));(n=this.searchResultsDialog)===null||n===void 0?void 0:n.show()}openSearchDialog(n){if(this.searchDialog){this.searchDialog.open();return}this.post("search-dialog",n).then(n=>{var t;(t=this.element)===null||t===void 0?void 0:t.append(n.dialog);this.searchDialog=new FileSearchDialog(`${this.id}_search_dialog`,this);this.searchDialog.open()})}table(){var n;if((n=this.folderPanel)!==null&&n!==void 0)return n.find("table.dbnetfile-table")}download(){switch(this.controlElement("ExportSelect").val()){case"html":this.htmlExport();break;case"excel":this.downloadSpreadsheet()}}htmlExport(){this.post("html-export",this.getRequest(),!0).then(n=>{const t=window.URL.createObjectURL(n),i=window.open();i.location.href=t})}downloadSpreadsheet(){this.post("generate-spreadsheet",this.getRequest(),!0).then(n=>{const t=document.createElement("a");t.href=window.URL.createObjectURL(n);t.download=`report_${(new Date).getTime()}.xlsx`;t.click()})}copyGrid(){var n,t;const i=this.table();(n=this.folderPanel)===null||n===void 0?void 0:n.find("tr.data-row.selected").addClass("unselected").removeClass("selected");this.copyTableToClipboard(i.get(0));(t=this.folderPanel)===null||t===void 0?void 0:t.find("tr.data-row.unselected").addClass("selected").removeClass("unselected");this.info("Data copied to clipboard",this.folderPanel)}getRequest(){const n=this._getRequest();return n.rootFolder=this.rootFolder,n.folder=this.folder,n.columns=this.columns.map(n=>n),n.quickSearch=this.quickSearch,n.quickSearchToken=this.quickSearchToken,n.toolbarButtonStyle=this.toolbarButtonStyle,n.search=this.search,n.export=this.export,n.copy=this.copy,n.upload=this.upload,n.navigation=this.navigation,n.pageSize=this.pageSize,n.currentPage=this.currentPage,n.caption=this.caption,n.fileName=this.fileName,n.orderBy=this.orderBy,n.orderByDirection=this.orderByDirection,n.searchParams=this.searchParams,n.searchFilterJoin=this.searchFilterJoin,n.isSearchResults=this.isSearchResults,n.includeSubfolders=this.includeSubfolders,n.treeView=this.treeView,n.filesOnly=this.filesOnly,n}}class FileColumn{constructor(n){this.type=n}}