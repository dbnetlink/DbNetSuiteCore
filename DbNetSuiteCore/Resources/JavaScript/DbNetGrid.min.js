"use strict";var ToolbarButtonStyle,BooleanDisplayMode,MultiRowSelectLocation;(function(n){n[n.Image=0]="Image";n[n.Text=1]="Text";n[n.ImageAndText=2]="ImageAndText"})(ToolbarButtonStyle||(ToolbarButtonStyle={})),function(n){n[n.TrueFalse=0]="TrueFalse";n[n.YesNo=1]="YesNo";n[n.Checkbox=2]="Checkbox"}(BooleanDisplayMode||(BooleanDisplayMode={})),function(n){n[n.Left=0]="Left";n[n.Right=1]="Right"}(MultiRowSelectLocation||(MultiRowSelectLocation={}));class DbNetGrid extends DbNetSuite{constructor(n){if(super(),this.autoRowSelect=!0,this.booleanDisplayMode=BooleanDisplayMode.TrueFalse,this.cellIndexCache={},this.columnName=undefined,this.columnFilters={},this.connectionType="SqlServer",this.connectionString="",this.copy=!0,this.culture="",this.currentPage=1,this.defaultColumn=undefined,this.dragAndDrop=!0,this.export_=!0,this.fixedFilterParams={},this.fixedFilterSql="",this.fromPart="",this.frozenHeader=!1,this.googleChartOptions=undefined,this.groupBy=!1,this.id="",this.initialised=!1,this.linkedGrids=[],this.multiRowSelect=!1,this.multiRowSelectLocation=MultiRowSelectLocation.Left,this.navigation=!0,this.nestedGrid=!1,this.optimizeForLargeDataset=!1,this.orderBy="",this.orderByDirection="asc",this.pageSize=20,this.primaryKey=undefined,this.quickSearch=!1,this.quickSearchDelay=1e3,this.quickSearchMinChars=3,this.quickSearchToken="",this.rowSelect=!0,this.search=!0,this.searchFilterJoin="",this.searchParams=[],this.toolbarButtonStyle=ToolbarButtonStyle.Image,this.toolbarPosition="Top",this.totalPages=0,this.view=!1,this.id=n,this.columns=[],this.element=$(`#${this.id}`),this.element.addClass("dbnetsuite").addClass("cleanslate"),this.element.length==0){alert(`DbNetGrid containing element '${this.id}' not found`);return}}initialize(){this.element&&(this.element.empty(),this.toolbarPosition=="Top"&&(this.toolbarPanel=this.addPanel("toolbar")),this.gridPanel=this.addPanel("grid"),this.toolbarPosition=="Bottom"&&(this.toolbarPanel=this.addPanel("toolbar")),this.loadingPanel=this.addPanel("loading"),this.addPanel("loadingIcon",this.loadingPanel),this.loadingPanel.addClass("dbnetgrid-loading"),this.loadingPanel.children().first().addClass("icon"),this.dropIcon=this.addPanel("dropIcon",$("body")),this.dropIcon.addClass("drop-icon"),this.post("initialize",this.getRequest()).then(n=>{this.updateColumns(n),this.configureGrid(n)}).catch(()=>{}),this.initialised=!0,this.fireEvent("onInitialized"))}setColumnExpressions(...n){n.forEach(n=>{const t={columnExpression:n};this.columns.push(new GridColumn(t))})}setColumnLabels(...n){let t=0;n.forEach(n=>{this.columns.length>t&&(this.columns[t].label=n,t++)})}setColumnProperty(n,t,i){if(n instanceof Array){n.forEach(n=>this.setColumnProperty(n,t,i));return}var r=this.columns.find(t=>this.matchingColumn(t,n));if(r==undefined){const t={columnExpression:n};r=new GridColumn(t,!0);this.columns.push(r)}r[t]=i}setColumnProperties(n,t){Object.keys(t).forEach(i=>{this.setColumnProperty(n,i,t[i])})}addNestedGrid(n){this.bind("onNestedClick",n);this.nestedGrid=!0}addLinkedGrid(n){this.linkedGrids.push(n)}columnIndex(n){let t=this.cellIndexCache[n];return t?t:(t=-1,this.gridPanel.find("th[data-columnname]").get().forEach(i=>{$(i).data("columnname")&&$(i).data("columnname").toString().toLowerCase()==n.toLowerCase()&&(t=i.cellIndex,this.cellIndexCache[n]=t)}),t)}columnCell(n,t){let i=this.columnIndex(n);return i==-1?null:(t===undefined&&(t=this.selectedRow()),t.cells[i])}selectedRow(){return this.gridPanel.find("tr.data-row.selected")[0]}selectedRows(){return this.gridPanel.find("tr.data-row.selected")}columnValue(n,t){var i=$(t).data(n.toLowerCase());if(i!==undefined)return i;let r=this.columnCell(n,t);return r?$(r).data("value"):null}reload(){this.currentPage=1;this.getPage()}getDataArray(n){this.post("data-array",this.getRequest()).then(t=>{n(t)})}matchingColumn(n,t){var r,i=!1;return n.columnExpression.includes(".")&&(i=n.columnExpression.split(".").pop().toLowerCase()==t.toLowerCase()),((r=n.columnExpression.split(" ").pop())===null||r===void 0?void 0:r.toLowerCase())==t.toLowerCase()&&(i=!0),i||(i=n.columnExpression.toLowerCase()==t.toLowerCase()),i}addPanel(n,t=null){const i=`${this.id}_${n}Panel`;return t==null&&(t=this.element),jQuery("<div>",{id:i}).appendTo(t),$(`#${i}`)}gridElement(n){return $(`#${this.gridElementId(n)}`)}gridElementId(n){return`${this.id}_${n}`}setInputElement(n,t){var i=this.gridElement(n);i.val(t.toString());i.width(`${t.toString().length}em`)}configureToolbar(n){var r,t,i;n.toolbar&&(r=["First","Next","Previous","Last","Download","Copy","View","Search"],r.forEach(n=>this.addEventListener(`${n}Btn`)));t=this.gridElement("dbnetgrid-toolbar").find(".navigation");i=this.gridElement("no-records-cell");n.totalRows==0?(t.hide(),i.show()):(t.show(),i.hide(),this.gridElement("dbnetgrid-toolbar").find(".navigation").show(),this.setInputElement("PageNumber",n.currentPage),this.setInputElement("PageCount",n.totalPages),this.setInputElement("Rows",n.totalRows),this.currentPage=n.currentPage,this.totalPages=n.totalPages,this.disable("FirstBtn",n.currentPage==1),this.disable("PreviousBtn",n.currentPage==1),this.disable("NextBtn",n.currentPage==n.totalPages),this.disable("LastBtn",n.currentPage==n.totalPages));this.disable("ViewBtn",n.totalRows==0);this.disable("DownloadBtn",n.totalRows==0);this.disable("CopyBtn",n.totalRows==0);this.gridElement("QuickSearch").on("keyup",n=>this.quickSearchKeyPress(n))}configureGrid(n){if(this.toolbarPanel&&(n.toolbar&&this.toolbarPanel.html(n.toolbar),this.configureToolbar(n)),this.gridPanel.html(n.data),this.gridPanel.find("tr.filter-row :input").get().forEach(n=>{let t=$(n),i=t.width();n.nodeName=="SELECT"?t.width(i+20):i<100&&t.width(100);t.on("keyup",n=>this.columnFilterKeyPress(n))}),this.gridPanel.find("tr.data-row").get().forEach(n=>{this.addRowEventHandlers($(n)),this.fireEvent("onRowTransform",{row:n})}),this.dragAndDrop){this.gridPanel.find("tr.header-row th").draggable({helper:"clone",cursor:"move"}).on("dragstart",(n,t)=>this.columnDragStarted(n,t)).on("dragstop",(n,t)=>this.columnDragStopped(n,t)).on("drag",(n,t)=>this.columnDrag(n,t));this.gridPanel.find("tr.header-row th").droppable().on("dropover",(n,t)=>this.dragDropOver(n,t)).on("dropout",(n,t)=>this.dragDropOut(n,t)).on("drop",(n,t)=>this.dragDropped(n,t))}if(this.gridPanel.find("tr.header-row th").get().forEach(n=>{$(n).on("click",()=>this.handleHeaderClick($(n)))}),this.gridPanel.find("tr.filter-row select").get().forEach(n=>{$(n).on("change",()=>this.runColumnFilterSearch())}),this.gridPanel.find("input.multi-select-checkbox").get().forEach(n=>{$(n).on("click",n=>this.handleRowSelectClick(n))}),this.gridPanel.find("button.nested-grid-button").get().forEach(n=>{$(n).on("click",n=>this.openNestedGrid(n))}),this.gridPanel.find("button.download").get().forEach(n=>{$(n).on("click",n=>this.downloadCellData(n.currentTarget,!1))}),this.gridPanel.find("img.image").get().forEach(n=>{this.downloadCellData(n.parentElement,!0)}),this.gridPanel.find("th[data-columnname]").get().forEach(n=>{const t=$(n).data("columnname"),i=n.cellIndex;this.gridPanel.find("tr.data-row").get().forEach(n=>{const r=n.cells[i];this.fireEvent("onCellTransform",{cell:r,row:n,columnName:t})})}),this.autoRowSelect&&this.gridPanel.find("tr.data-row").first().trigger("click"),this.fireEvent("onPageLoaded",{table:this.gridPanel.find("table.dbnetgrid-table")[0]}),this.renderChart(),this.frozenHeader){let n=$(this.gridPanel.find("tr.header-row")).height();var t=$(this.gridPanel.find("tr.filter-row"));t.find("th").css("top",n)}}renderChart(){this.googleChartOptions&&this.getDataArray(n=>this.loadChart(n))}loadChart(n){google.charts.load("current",{packages:["corechart"]});google.charts.setOnLoadCallback(()=>this.drawChart(n))}drawChart(n){var t,i,u=google.visualization.arrayToDataTable(n),f=new google.visualization[this.googleChartOptions.type](document.getElementById(this.googleChartOptions.panelId)),r={};((t=this.googleChartOptions)===null||t===void 0?void 0:t.functionName)&&window[(i=this.googleChartOptions)===null||i===void 0?void 0:i.functionName](this,r);f.draw(u,r)}updateColumns(n){this.columns=[];n.columns.forEach(n=>{const t={columnExpression:n.columnExpression,columnName:n.columnName,label:n.label,format:n.format,foreignKey:n.foreignKey,foreignKeyValue:n.foreignKeyValue,lookup:n.lookup,style:n.style,display:n.display,filter:n.filter,filterMode:n.filterMode,groupHeader:n.groupHeader,download:n.download,image:n.image,view:n.view,dataType:n.dataType,aggregate:n.aggregate,totalBreak:n.totalBreak,clearDuplicateValue:n.clearDuplicateValue,primaryKey:n.primaryKey,index:n.index,dataOnly:n.dataOnly};this.columns.push(new GridColumn(t))})}columnDragStarted(n,t){var i=$(n.currentTarget);i.css("opacity",.5);t.helper.css("opacity",.5);t.helper.attr("dbnetgrid_id",this.id);t.helper.width(i.width()+2).height(i.height()+2)}columnDragStopped(n){var t=$(n.currentTarget);t.css("opacity",1)}columnDrag(n,t){if(this.dropTarget&&t.helper.attr("dbnetgrid_id")==this.id){this.dropIcon.show();var r=this.dropTarget.width(),i=this.dropTarget.offset(),f=this.dropTarget.parent().offset(),e=t.position.left+f.left,u=i.left-9,o=i.top-14;t.helper.attr("dropside","left");e+r>i.left&&(t.helper.attr("dropside","right"),u+=r+4,console.log);this.dropIcon.css({left:`${u}px`,top:`${o}px`})}}dragDropOver(n,t){t.helper.attr("dbnetgrid_id")==this.id&&(this.dropTarget=$(n.currentTarget))}dragDropOut(){this.dropIcon.hide();this.dropTarget=undefined}dragDropped(n,t){var i;if(t.helper.attr("dbnetgrid_id")==this.id){this.dropIcon.hide();var r=[],u=parseInt(t.draggable.data("columnordinal"))-1,f=parseInt($(n.currentTarget).data("columnordinal"))-1,e=this.columns[u],o=t.helper.attr("dropside");for(i=0;i<this.columns.length;i++)i==f&&o=="left"&&r.push(e),i!=u&&r.push(this.columns[i]),i==f&&o=="right"&&r.push(e);this.columns=r;this.orderBy="";this.getPage()}}addRowEventHandlers(n){n.on("mouseover",()=>n.addClass("highlight"));n.on("mouseout",()=>n.removeClass("highlight"));n.on("click",()=>this.handleRowClick(n))}handleRowClick(n){this.rowSelect&&(n.parent().find("tr.data-row").removeClass("selected").find("input.multi-select-checkbox").prop("checked",!1),n.addClass("selected").find("input.multi-select-checkbox").prop("checked",!0));this.linkedGrids.forEach(t=>{this.assignForeignKey(t,n.data("id")),t.connectionString==""&&(t.connectionString=this.connectionString),t.currentPage=1,t.initialised?t.getPage():t.initialize()});this.viewDialog&&this.viewDialog.isOpen()&&this.getViewContent();this.fireEvent("onRowSelected",{row:n[0]})}handleHeaderClick(n){this.orderBy=n.data("columnordinal");let t=n.data("dbdatatype");switch(t){case"text":case"ntext":case"image":return}this.orderByDirection="asc";n.attr("orderby")&&(this.orderByDirection=n.attr("orderby")=="asc"?"desc":"asc");this.getPage()}handleRowSelectClick(n){var i=$(n.currentTarget),t;const r=i.is(":checked");i.parent().prop("tagName")=="TH"?(t=i.closest("table").find("tbody").children(),t.get().forEach(n=>$(n).find("input.multi-select-checkbox").prop("checked",r))):t=i.parent().parent("tr");r?t.addClass("selected"):t.removeClass("selected");n.stopPropagation()}handleClick(n){var t=n.target.id;switch(t){case this.gridElementId("FirstBtn"):this.currentPage=1;break;case this.gridElementId("NextBtn"):this.currentPage++;break;case this.gridElementId("PreviousBtn"):this.currentPage--;break;case this.gridElementId("LastBtn"):this.currentPage=this.totalPages;break;case this.gridElementId("DownloadBtn"):case this.gridElementId("CopyBtn"):case this.gridElementId("ViewBtn"):case this.gridElementId("SearchBtn"):break;default:return}n.preventDefault();switch(t){case this.gridElementId("DownloadBtn"):this.download();break;case this.gridElementId("CopyBtn"):this.copyGrid();break;case this.gridElementId("ViewBtn"):this.getViewContent();break;case this.gridElementId("SearchBtn"):this.openSearchDialog();break;default:this.getPage()}}quickSearchKeyPress(n){var t=n.target;window.clearTimeout(this.quickSearchTimerId);(t.value.length>=this.quickSearchMinChars||t.value.length==0||n.key=="Enter")&&(this.quickSearchTimerId=window.setTimeout(()=>{this.runQuickSearch(t.value)},this.quickSearchDelay))}columnFilterKeyPress(){window.clearTimeout(this.quickSearchTimerId);this.quickSearchTimerId=window.setTimeout(()=>{this.runColumnFilterSearch()},this.quickSearchDelay)}runQuickSearch(n){this.quickSearchToken=n;this.currentPage=1;this.getPage()}runColumnFilterSearch(){this.columnFilters={};this.gridPanel.find("tr.filter-row input").get().forEach(n=>{var t=$(n);t.val()!=""&&(this.columnFilters[t.data("columnname")]=t.val().toString())});this.gridPanel.find("tr.filter-row select").get().forEach(n=>{var t=$(n);t.val()!=""&&(this.columnFilters[t.data("columnname")]=t.val().toString())});this.searchDialog&&(this.searchDialog.clear(),this.searchParams=[]);this.currentPage=1;this.getPage()}clearColumnFilters(){this.columnFilters={};this.gridPanel.find("tr.filter-row input").get().forEach(n=>{var t=$(n);t.val("")});this.gridPanel.find("tr.filter-row select").get().forEach(n=>{var t=$(n);t.val("")})}getPage(n){let t=this.activeElementId();this.post("page",this.getRequest()).then(i=>{i.error==!1&&(this.configureGrid(i),this.focusActiveElement(t)),n&&n(i)})}lookup(n){var t=this.getRequest();if(t.lookupColumnIndex=parseInt(n.attr("columnIndex")),this.lookupDialog&&t.lookupColumnIndex==this.lookupDialog.columnIndex){this.lookupDialog.open();return}this.post("lookup",t).then(t=>{this.lookupDialog||(this.element.append(t.toolbar),this.lookupDialog=new LookupDialog(`${this.id}_lookup_dialog`,this)),this.lookupDialog.update(t,n),this.lookupDialog.open()})}activeElementId(){var n,t;let i=undefined;return((n=document.activeElement)===null||n===void 0?void 0:n.nodeName)=="INPUT"&&(i=(t=document.activeElement)===null||t===void 0?void 0:t.id),i}focusActiveElement(n){if(n){let t=$(`#${n}`),i=t.val();t.trigger("focus").val(i);t[0].setSelectionRange(i.length,i.length)}}download(){switch(this.gridElement("DownloadSelect").val()){case"html":this.htmlExport();break;case"excel":this.downloadSpreadsheet()}}htmlExport(){this.post("html-export",this.getRequest(),!0).then(n=>{let t=window.URL.createObjectURL(n),i=window.open();i.location.href=t})}downloadSpreadsheet(){this.post("generate-spreadsheet",this.getRequest(),!0).then(n=>{const t=document.createElement("a");t.href=window.URL.createObjectURL(n);t.download=`report_${(new Date).getTime()}.xlsx`;t.click()})}getViewContent(){let n=$(this.selectedRow());this.primaryKey=n.data("id");this.post("view-content",this.getRequest()).then(t=>{this.viewDialog||(this.element.append(t.toolbar),this.viewDialog=new ViewDialog(`${this.id}_view_dialog`,this)),this.viewDialog.update(t,n)})}openSearchDialog(){if(this.searchDialog){this.searchDialog.open();return}this.post("search-dialog",this.getRequest()).then(n=>{this.element.append(n.data),this.searchDialog=new SearchDialog(`${this.id}_search_dialog`,this),this.searchDialog.open()})}copyGrid(){var t=this.gridPanel[0].querySelector("table.dbnetgrid-table"),n;this.gridPanel.find("tr.data-row.selected").addClass("unselected").removeClass("selected");try{n=document.createRange();n.selectNode(t);window.getSelection().addRange(n);document.execCommand("copy");window.getSelection().removeRange(n)}catch(i){try{const n=t.innerHTML,i=new Blob([n],{type:"text/html"}),r=new ClipboardItem({"text/html":i});navigator.clipboard.write([r])}catch(i){alert("Copy failed");return}}this.gridPanel.find("tr.data-row.unselected").addClass("selected").removeClass("unselected");this.message("Copied")}message(n){let i=`${this.id}_message_dialog`,t=$(`#${i}`);t.text(n);t.attr("title","Copy");t.dialog({autoOpen:!1});t.dialog("open")}getRequest(){this.defaultColumn=this.columns.find(n=>n.columnExpression=="*");this.defaultColumn&&(this.columns=this.columns.filter(n=>n!==this.defaultColumn));return{componentId:this.id,connectionString:this.connectionString,fromPart:this.fromPart,currentPage:this.currentPage,pageSize:this.toolbarPosition=="Hidden"?-1:this.pageSize,orderBy:this.orderBy,orderByDirection:this.orderByDirection,toolbarButtonStyle:this.toolbarButtonStyle,columns:this.columns.map(n=>n),multiRowSelect:this.multiRowSelect,multiRowSelectLocation:this.multiRowSelectLocation,nestedGrid:this.nestedGrid,quickSearch:this.quickSearch,quickSearchToken:this.quickSearchToken,booleanDisplayMode:this.booleanDisplayMode,columnFilters:this.columnFilters,frozenHeader:this.frozenHeader,optimizeForLargeDataset:this.optimizeForLargeDataset,defaultColumn:this.defaultColumn,primaryKey:this.primaryKey,columnName:this.columnName,view:this.view,groupBy:this.groupBy,search:this.search,searchFilterJoin:this.searchFilterJoin,searchParams:this.searchParams,copy:this.copy,"export":this.export_,navigation:this.navigation,culture:this.culture,fixedFilterParams:this.fixedFilterParams,fixedFilterSql:this.fixedFilterSql}}addEventListener(n,t="click"){this.gridElement(n).on(t,n=>this.handleClick(n))}disable(n,t){this.gridElement(n).prop("disabled",t)}showLoader(){this.loadingPanel.addClass("display")}hideLoader(){this.loadingPanel.removeClass("display")}post(n,t,i=false){this.showLoader();const r={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json;charset=UTF-8"},body:JSON.stringify(t)};return fetch(`~/dbnetgrid.dbnetsuite?action=${n}`,r).then(n=>{if(this.hideLoader(),!n.ok)throw n;return i?n.blob():n.json()}).catch(n=>(n.text().then(n=>{console.error(n),this.gridPanel.text(n.split("\n").shift())}),Promise.reject()))}downloadCellData(n,t){var r,e=$(n).closest("tr.view-content-row"),i,u;const o=$(n);i=o.closest("td");u=o.closest("tr");e.length?this.columnName=e.data("columnname"):(this.primaryKey=u.data("id"),this.columnName=(r=this.gridPanel.find("th[data-columnname]").get(i.prop("cellIndex")))===null||r===void 0?void 0:r.getAttribute("data-columnname"));let f={row:u.get(0),cell:i.get(0),extension:"xlxs",fileName:`${this.columnName}_${this.primaryKey}.xlsx`,columnName:this.columnName};t&&(f.image=i.find("img").get(0));this.fireEvent("onCellDataDownload",f);this.post("download-column-data",this.getRequest(),!0).then(n=>{if(t){let t=i.find("img");t.attr("src",window.URL.createObjectURL(n))}else{const t=document.createElement("a");t.href=window.URL.createObjectURL(n);t.download=f.fileName;t.click()}})}openNestedGrid(n){var t,o,e,u,f,r;const i=$(n.currentTarget);if(t=i.closest("tr"),i.hasClass("open")){i.removeClass("open");t.next().hide();return}if(o=i.closest("table"),i.addClass("open"),t.next().hasClass("nested-grid-row")){t.next().show();return}for(e=o[0].insertRow(t[0].rowIndex+1),e.className="nested-grid-row",u=e.insertCell(-1),u.className="nested-grid-cell",u.colSpan=t[0].cells.length,f=this.eventHandlers.onNestedClick,r=0;r<f.length;r++)f[r]&&this.configureNestedGrid(f[r],u,t.data("id"))}configureNestedGrid(n,t,i){var u=`dbnetgrid${(new Date).valueOf()}`,r,f;jQuery(document.createElement("div")).attr("id",u).appendTo($(t));r=new DbNetGrid(u);r.connectionString=this.connectionString;f=[r,this];n.apply(window,f);this.assignForeignKey(r,i);r.initialize()}assignForeignKey(n,t){var i=n.columns.find(n=>n.foreignKey==!0);if(i==undefined){alert("No foreign key defined for nested grid");return}i.foreignKeyValue=t}}