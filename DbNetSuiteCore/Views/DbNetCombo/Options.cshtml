@namespace DbNetSuiteCore.Views.DbNetGrid
@using DbNetSuiteCore.Helpers;
@using DbNetSuiteCore.ViewModels.DbNetCombo;
@using System.Data
@using Microsoft.AspNetCore.Html;
@using System.Text.Json;
@model ComboViewModel
@{
    if (Model.AddEmptyOption && Model.DataView.Count > 0)
    {
        <option value="">@(Model.EmptyOptionText ?? string.Empty)</option>
    }

    foreach (DataRowView dataViewRow in Model.DataView)
    {
        string columnName = dataViewRow.Row.Table.Columns[Model.ValueIndex].ToString();
        string value = dataViewRow.Row[Model.ValueIndex].ToString();
        <option value="@value" data-pk="@EncodeValue(value,columnName)" @DataAttributes(Model.TextIndex,dataViewRow)>@dataViewRow.Row[Model.TextIndex].ToString()</option>
    }
}
@functions
{
    public HtmlString DataAttributes(int textIndex, DataRowView dataRowView)
    {
        List<string> dataAttributes = new List<string>();

        if (string.IsNullOrEmpty(Model.ProcedureName) == false)
        {
            return new HtmlString(string.Empty);
        }

        for (int i = textIndex+1; i < Model.DataView.Table.Columns.Count; i++)
        {
            string value = null;

            if (dataRowView.Row[i] != null && dataRowView.Row[i] != System.DBNull.Value)
            {
                value = dataRowView.Row[i].ToString().Replace(" ", "&nbsp;");
                dataAttributes.Add($"data-{Model.DataView.Table.Columns[i].ColumnName.ToLower()}={value}");
            }
         }

        return new HtmlString(string.Join(" ", dataAttributes.ToArray()));
    }

    public string EncodeValue(string value, string columnName)
    {
        Dictionary<string, object> primaryKeyValues = new Dictionary<string, object>();
        primaryKeyValues.Add(columnName, value);
        return EncodingHelper.Encode(JsonSerializer.Serialize(primaryKeyValues));
    }
}